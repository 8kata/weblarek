(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))r(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const g of a.addedNodes)g.tagName==="LINK"&&g.rel==="modulepreload"&&r(g)}).observe(document,{childList:!0,subtree:!0});function t(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function r(o){if(o.ep)return;o.ep=!0;const a=t(o);fetch(o.href,a)}})();class P{baseUrl;options;constructor(e,t={}){this.baseUrl=e,this.options={headers:{"Content-Type":"application/json",...t.headers??{}}}}handleResponse(e){return e.ok?e.json():e.json().then(t=>Promise.reject(t.error??e.statusText))}get(e){return fetch(this.baseUrl+e,{...this.options,method:"GET"}).then(this.handleResponse)}post(e,t,r="POST"){return fetch(this.baseUrl+e,{...this.options,method:r,body:JSON.stringify(t)}).then(this.handleResponse)}}class T{_events;constructor(){this._events=new Map}on(e,t){this._events.has(e)||this._events.set(e,new Set),this._events.get(e)?.add(t)}off(e,t){this._events.has(e)&&(this._events.get(e).delete(t),this._events.get(e)?.size===0&&this._events.delete(e))}emit(e,t){this._events.forEach((r,o)=>{o==="*"&&r.forEach(a=>a({eventName:e,data:t})),(o instanceof RegExp&&o.test(e)||o===e)&&r.forEach(a=>a(t))})}onAll(e){this.on("*",e)}offAll(){this._events=new Map}trigger(e,t){return(r={})=>{this.emit(e,{...r||{},...t||{}})}}}class L{api;catalog;basket;constructor(e,t,r){this.api=e,this.catalog=t,this.basket=r}getApi(){return this.api.get("/product/").then(e=>(this.catalog.setProducts(e.items),e.items)).catch(e=>(console.error("Не удалось загрузить каталог",e),[]))}postApi(e){const t={...e,items:this.basket.getBasket().map(r=>r.id),total:this.basket.getTotalPrise()};this.api.post("/order",t).then(()=>{this.basket.clearBasket()}).catch(r=>{console.error("Не удалось обработать заказ",r)})}}class I{constructor(e=[],t){this.events=t,this.basket=e}basket;getBasket(){return[...this.basket]}setProductItem(e){this.basket.push(e),this.events.emit("basket:changed")}deleteProductItem(e){this.basket=this.basket.filter(t=>t.id!==e),this.events.emit("basket:changed")}clearBasket(){this.basket=[],this.events.emit("basket:changed")}getTotalPrise(){return this.basket.reduce((e,t)=>e+(t.price||0),0)}getProductCounter(){return this.basket.length}inBasket(e){return this.basket.some(t=>t.id===e)}}class E{constructor(e="card",t="",r="",o="",a){this.events=a,this._payment=e,this._address=t,this._phone=r,this._email=o}_payment;_address;_phone;_email;set payment(e){this._payment=e,this.events.emit("order:changed")}set address(e){this._address=e,this.events.emit("order:changed")}set phone(e){this._phone=e,this.events.emit("order:changed")}set email(e){this._email=e,this.events.emit("order:changed")}getOrder(){return{...{payment:this._payment,address:this._address,phone:this._phone,email:this._email}}}clearOrder(){this._payment="card",this._address="",this._phone="",this._email=""}validateForm(e){const t=this.getOrder();if(e==="addressForm"){const r=!!t.address;return{isValid:r,error:r?"":"Необходимо указать адрес"}}if(e==="contactsForm"){const r=!!t.email,o=!!t.phone;if(!r&&!o)return{isValid:!1,error:"Необходимо указать email и телефон"};if(r){if(!o)return{isValid:!1,error:"Необходимо указать телефон"}}else return{isValid:!1,error:"Необходимо указать email"};return{isValid:!0,error:""}}return{isValid:!1,error:""}}}class F{constructor(e=[],t=null,r){this.events=r,this.products=e,this.selectedProduct=t}products;selectedProduct;setProducts(e){this.products=e,this.events.emit("catalog:changed",this.products)}getProducts(){return[...this.products]}getProductItem(e){const t=this.products.find(r=>r.id===e);if(!t)throw new Error(`Товар с id "${e}" не найден`);return t}setSelectedProduct(e){this.selectedProduct=e}getSelectedProduct(){return this.selectedProduct}}const A="https://larek-api.nomoreparties.co/api/weblarek",O="https://larek-api.nomoreparties.co/content/weblarek",p={"софт-скил":"card__category_soft","хард-скил":"card__category_hard",кнопка:"card__category_button",дополнительное:"card__category_additional",другое:"card__category_other"};function B(s){return typeof s=="string"&&s.length>1}function w(s,e=document){if(B(s))return Array.from(e.querySelectorAll(s));if(s instanceof NodeList)return Array.from(s);if(Array.isArray(s))return s;throw new Error("Unknown selector element")}function i(s,e){if(B(s)){const t=w(s,e);if(t.length>1&&console.warn(`selector ${s} return more then one element`),t.length===0)throw new Error(`selector ${s} return nothing`);return t.pop()}if(s instanceof HTMLElement)return s;throw new Error("Unknown selector element")}function l(s){const e=i(s);if(!e.content.firstElementChild)throw new Error(`Template ${s} has no content`);return e.content.firstElementChild.cloneNode(!0)}class h{constructor(e){this.container=e}setImage(e,t,r){e&&(e.src=O+t,r&&(e.alt=r))}setText(e,t){e&&(e.textContent=t)}setDisable(e,t){e.toggleAttribute("disabled",t)}render(e){return Object.assign(this,e??{}),this.container}}class b extends h{_title;_price;_titleText="";constructor(e){super(e),this._title=i(".card__title",this.container),this._price=i(".card__price",this.container)}set title(e){this.setText(this._title,e),this._titleText=e}set price(e){const t=e?`${e} синапсов`:"Бесценно";this.setText(this._price,t)}get title(){return this._titleText}render(e){return super.render(e)}}class S extends b{_category;_image;constructor(e,t){super(e),t?.onClick&&this.container.addEventListener("click",t.onClick),this._category=i(".card__category",this.container),this._image=i(".card__image",this.container)}set category(e){this.setText(this._category,e);for(const t in p)this._category.classList.toggle(p[t],t===e)}set image(e){this.setImage(this._image,e,this.title)}render(e){return super.render(e)}}class V extends b{_category;_image;_description;_button;constructor(e,t){super(e),this._category=i(".card__category",this.container),this._image=i(".card__image",this.container),this._description=i(".card__text",this.container),this._button=i(".card__button",this.container),this._button&&t?.onClick&&this._button.addEventListener("click",t.onClick)}set category(e){this.setText(this._category,e);for(const t in p)this._category.classList.toggle(p[t],t===e)}set image(e){this.setImage(this._image,e,this.title)}set description(e){this.setText(this._description,e)}set inBasket(e){this._price.textContent!=="Бесценно"&&this.setText(this._button,e?"Удалить из корзины":"Купить")}set price(e){super.price=e,e===null&&(this.setText(this._button,"Недоступно"),this.setDisable(this._button,!0))}render(e){return super.render(e)}}class M extends h{_catalog;_locked;constructor(e){super(e),this._catalog=i(".gallery",this.container),this._locked=i(".page__wrapper",this.container)}set catalog(e){this._catalog.replaceChildren(...e)}set locked(e){this._locked.classList.toggle("page__wrapper_locked",e)}render(e){return super.render(e)}}class $ extends h{constructor(e,t){super(e),this.events=t,this._content=i(".modal__content",this.container),this._closeButtons=i(".modal__close",this.container),this._closeButtons.addEventListener("click",()=>this.events.emit("modal:close")),this.container.addEventListener("click",r=>{r.target===this.container&&this.events.emit("modal:close")})}_content;_closeButtons;set content(e){this._content.replaceChildren(e)}open(){this.container.classList.add("modal_active")}close(){this.container.classList.remove("modal_active")}render(e){return super.render(e)}}class U extends h{constructor(e,t){super(e),this.events=t,this._basketButton=i(".header__basket",this.container),this._counter=i(".header__basket-counter",this.container),this._basketButton.addEventListener("click",()=>{this.events.emit("basket:open")})}_basketButton;_counter;set counter(e){this.setText(this._counter,String(e))}render(e){return super.render(e)}}class D extends b{constructor(e,t){super(e),this.events=t,this._index=i(".basket__item-index",this.container),this._deleteButton=i(".basket__item-delete",this.container),this._deleteButton.addEventListener("click",()=>{this.events.emit("basket:delete",{id:this._deleteButton.dataset.id||""})})}_index;_deleteButton;set index(e){this.setText(this._index,String(e+1))}set id(e){this._deleteButton.dataset.id=String(e)}render(e){return super.render(e)}}class R extends h{constructor(e,t){super(e),this.events=t,this._list=i(".basket__list",this.container),this._total=i(".basket__price",this.container),this._buyButton=i(".basket__button",this.container),this._empty=i(".basket__empty",this.container),this._buyButton.addEventListener("click",()=>{t.emit("order:open")})}_list;_total;_buyButton;_empty;set list(e){this._list.replaceChildren(...e),this.empty=e.length===0}set total(e){this.setText(this._total,`${e} синапсов`)}set empty(e){this.setDisable(this._buyButton,e),this._empty.style.display=e?"block":"none"}render(e){return super.render(e)}}class C extends h{_submitButton;_error;constructor(e){super(e),this._submitButton=i('.button[type="submit"]',this.container),this._error=i(".form__errors",this.container)}set valid(e){this.setDisable(this._submitButton,!e)}set error(e){this.setText(this._error,e)}render(e){return super.render(e)}}class j extends C{constructor(e,t,r){super(e),this.events=t,this._addressInput=i('input[name="address"]',this.container),this._paymentButtons=w(".button_alt",this.container),r?.onClick&&this.container.addEventListener("submit",o=>{o.preventDefault(),r.onClick()}),this._addressInput.addEventListener("input",()=>{this.events.emit("order.address:changed",{value:this._addressInput.value})}),this._paymentButtons.forEach(o=>{o.addEventListener("click",()=>{this.events.emit("order.payment:changed",{value:o.name})})})}_addressInput;_paymentButtons;set payment(e){this._paymentButtons.forEach(t=>{t.classList.toggle("button_alt-active",t.name===e)})}set address(e){this._addressInput.value=e??""}render(e){return super.render(e)}}class G extends C{constructor(e,t,r){super(e),this.events=t,this._emailInput=i('input[name="email"]',this.container),this._phoneInput=i('input[name="phone"]',this.container),r?.onClick&&this.container.addEventListener("submit",o=>{o.preventDefault(),r.onClick()}),this._emailInput.addEventListener("input",()=>{this.events.emit("order.email:changed",{value:this._emailInput.value})}),this._phoneInput.addEventListener("input",()=>{this.events.emit("order.phone:changed",{value:this._phoneInput.value})})}_emailInput;_phoneInput;set email(e){this._emailInput.value=e??""}set phone(e){this._phoneInput.value=e??""}render(e){return super.render(e)}}class H extends h{constructor(e,t){super(e),this.events=t,this._total=i(".order-success__description",this.container),this._closeButton=i(".order-success__close",this.container),this._closeButton.addEventListener("click",()=>{this.events.emit("modal:close")})}_total;_closeButton;set total(e){this.setText(this._total,`Списано ${e} синапсов`)}render(e){return super.render(e)}}const q=i("#card-catalog"),z=i("#card-preview"),J=i("#card-basket"),K=i("#basket"),N=i("#order"),Q=i("#contacts"),W=i("#success"),X=i("#modal-container"),Y=i(".header__container"),Z=new P(A),n=new T,m=new F([],null,n),d=new I([],n),x=new L(Z,m,d),c=new E("card","","","",n),f=new $(X,n),ee=new U(Y,n),k=new M(document.body),v=new R(l(K),n),u=new j(l(N),n,{onClick:()=>n.emit("addressForm:submit")}),_=new G(l(Q),n,{onClick:()=>n.emit("contactsForm:submit")}),y=new H(l(W),n),te=()=>{n.on("modal:open",s=>{s&&(f.render({content:s}),f.open(),k.locked=!0)}),n.on("modal:close",()=>{f.close(),k.locked=!1})},se=()=>{n.on("catalog:changed",()=>{const s=m.getProducts().map(e=>new S(l(q),{onClick:()=>n.emit("card:selected",e)}).render(e));k.render({catalog:s})}),n.on("card:selected",s=>{m.setSelectedProduct(s);const e=d.inBasket(s.id),r=new V(l(z),{onClick:()=>{e?(n.emit("basket:delete",{id:s.id}),n.emit("modal:close")):n.emit("basket:add",s)}}).render({...s,inBasket:e});n.emit("modal:open",r)})},re=()=>{n.on("basket:changed",()=>{const s=d.getBasket().map((e,t)=>new D(l(J),n).render({...e,index:t,id:e.id}));v.render({list:s,total:d.getTotalPrise(),empty:d.getBasket().length===0}),ee.render({counter:d.getProductCounter()})}),n.on("basket:add",s=>{d.setProductItem(s),n.emit("modal:close")}),n.on("basket:delete",s=>{d.deleteProductItem(s.id)}),n.on("basket:open",()=>{n.emit("modal:open",v.render())})},ne=()=>{let s=u;n.on("order:open",()=>{const e=c.getOrder(),t=c.validateForm("addressForm");s=u,u.render({...e,valid:t.isValid,error:t.error}),n.emit("modal:open",u.render())}),n.on("addressForm:submit",()=>{const e=c.getOrder(),t=c.validateForm("contactsForm");s=_,_.render({...e,valid:t.isValid,error:t.error}),n.emit("modal:open",_.render())}),n.on("contactsForm:submit",()=>{const e=d.getTotalPrise();x.postApi(c.getOrder()),y.render({total:e}),n.emit("modal:open",y.render())}),n.on("order.address:changed",e=>{c.address=e.value}),n.on("order.payment:changed",e=>{c.payment=e.value}),n.on("order.email:changed",e=>{c.email=e.value}),n.on("order.phone:changed",e=>{c.phone=e.value}),n.on("order:changed",()=>{const e=c.getOrder();if(s===u){const t=c.validateForm("addressForm");u.render({...e,valid:t.isValid,error:t.error})}else{const t=c.validateForm("contactsForm");_.render({...e,valid:t.isValid,error:t.error})}})},ie=()=>{te(),se(),re(),ne(),x.getApi().then(()=>{console.log("Массив товаров полученного с сервера",m.getProducts())}).catch(s=>{console.log("Ошибка получения товаров с сервера",s)})};ie();
