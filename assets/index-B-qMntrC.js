(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))r(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const g of a.addedNodes)g.tagName==="LINK"&&g.rel==="modulepreload"&&r(g)}).observe(document,{childList:!0,subtree:!0});function e(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function r(o){if(o.ep)return;o.ep=!0;const a=e(o);fetch(o.href,a)}})();class P{baseUrl;options;constructor(t,e={}){this.baseUrl=t,this.options={headers:{"Content-Type":"application/json",...e.headers??{}}}}handleResponse(t){return t.ok?t.json():t.json().then(e=>Promise.reject(e.error??t.statusText))}get(t){return fetch(this.baseUrl+t,{...this.options,method:"GET"}).then(this.handleResponse)}post(t,e,r="POST"){return fetch(this.baseUrl+t,{...this.options,method:r,body:JSON.stringify(e)}).then(this.handleResponse)}}class T{_events;constructor(){this._events=new Map}on(t,e){this._events.has(t)||this._events.set(t,new Set),this._events.get(t)?.add(e)}off(t,e){this._events.has(t)&&(this._events.get(t).delete(e),this._events.get(t)?.size===0&&this._events.delete(t))}emit(t,e){this._events.forEach((r,o)=>{o==="*"&&r.forEach(a=>a({eventName:t,data:e})),(o instanceof RegExp&&o.test(t)||o===t)&&r.forEach(a=>a(e))})}onAll(t){this.on("*",t)}offAll(){this._events=new Map}trigger(t,e){return(r={})=>{this.emit(t,{...r||{},...e||{}})}}}class L{api;catalog;basket;constructor(t,e,r){this.api=t,this.catalog=e,this.basket=r}getApi(){return this.api.get("/product/").then(t=>(this.catalog.setProducts(t.items),t.items)).catch(t=>(console.error("Не удалось загрузить каталог",t),[]))}postApi(t){const e={...t,items:this.basket.getBasket().map(r=>r.id),total:this.basket.getTotalPrise()};this.api.post("/order",e).then(()=>{this.basket.clearBasket()}).catch(r=>{console.error("Не удалось обработать заказ",r)})}}class I{constructor(t=[],e){this.events=e,this.basket=t}basket;getBasket(){return[...this.basket]}setProductItem(t){this.basket.push(t),this.events.emit("basket:changed")}deleteProductItem(t){this.basket=this.basket.filter(e=>e.id!==t),this.events.emit("basket:changed")}clearBasket(){this.basket=[],this.events.emit("basket:changed")}getTotalPrise(){return this.basket.reduce((t,e)=>t+(e.price||0),0)}getProductCounter(){return this.basket.length}inBasket(t){return this.basket.some(e=>e.id===t)}}class E{constructor(t="card",e="",r="",o="",a){this.events=a,this._payment=t,this._address=e,this._phone=r,this._email=o}_payment;_address;_phone;_email;set payment(t){this._payment=t,this.events.emit("order:changed")}set address(t){this._address=t,this.events.emit("order:changed")}set phone(t){this._phone=t,this.events.emit("order:changed")}set email(t){this._email=t,this.events.emit("order:changed")}getOrder(){return{...{payment:this._payment,address:this._address,phone:this._phone,email:this._email}}}clearOrder(){this._payment="card",this._address="",this._phone="",this._email=""}validateForm(t){const e=this.getOrder();if(t==="addressForm"){const r=!!e.address;return{isValid:r,error:r?"":"Необходимо указать адрес"}}if(t==="contactsForm"){const r=!!e.email,o=!!e.phone;if(!r&&!o)return{isValid:!1,error:"Необходимо указать email и телефон"};if(r){if(!o)return{isValid:!1,error:"Необходимо указать телефон"}}else return{isValid:!1,error:"Необходимо указать email"};return{isValid:!0,error:""}}return{isValid:!1,error:""}}}class F{constructor(t=[],e=null,r){this.events=r,this.products=t,this.selectedProduct=e}products;selectedProduct;setProducts(t){this.products=t,this.events.emit("catalog:changed",this.products)}getProducts(){return[...this.products]}getProductItem(t){const e=this.products.find(r=>r.id===t);if(!e)throw new Error(`Товар с id "${t}" не найден`);return e}setSelectedProduct(t){this.selectedProduct=t}getSelectedProduct(){return this.selectedProduct}}const A="https://larek-api.nomoreparties.co/api/weblarek",O="https://larek-api.nomoreparties.co/content/weblarek",_={"софт-скил":"card__category_soft","хард-скил":"card__category_hard",кнопка:"card__category_button",дополнительное:"card__category_additional",другое:"card__category_other"};function B(s){return typeof s=="string"&&s.length>1}function w(s,t=document){if(B(s))return Array.from(t.querySelectorAll(s));if(s instanceof NodeList)return Array.from(s);if(Array.isArray(s))return s;throw new Error("Unknown selector element")}function n(s,t){if(B(s)){const e=w(s,t);if(e.length>1&&console.warn(`selector ${s} return more then one element`),e.length===0)throw new Error(`selector ${s} return nothing`);return e.pop()}if(s instanceof HTMLElement)return s;throw new Error("Unknown selector element")}function h(s){const t=n(s);if(!t.content.firstElementChild)throw new Error(`Template ${s} has no content`);return t.content.firstElementChild.cloneNode(!0)}class l{constructor(t){this.container=t}setImage(t,e,r){t&&(t.src=O+e,r&&(t.alt=r))}setText(t,e){t&&(t.textContent=e)}setDisable(t,e){t.toggleAttribute("disabled",e)}render(t){return Object.assign(this,t??{}),this.container}}class k extends l{_title;_price;_titleText="";constructor(t){super(t),this._title=n(".card__title",this.container),this._price=n(".card__price",this.container)}set title(t){this.setText(this._title,t),this._titleText=t}set price(t){const e=t?`${t} синапсов`:"Бесценно";this.setText(this._price,e)}get title(){return this._titleText}render(t){return t?.title&&(this.title=t.title),t?.price!==void 0&&(this.price=t.price),this.container}}class V extends k{_category;_image;constructor(t,e){super(t),e?.onClick&&this.container.addEventListener("click",e.onClick),this._category=n(".card__category",this.container),this._image=n(".card__image",this.container)}set category(t){this.setText(this._category,t);for(const e in _)this._category.classList.toggle(_[e],e===t)}set image(t){this.setImage(this._image,t,this.title)}render(t){return super.render(t),t?.category&&(this.category=t.category),t?.image&&(this.image=t.image),this.container}}class S extends k{_category;_image;_description;_button;constructor(t,e){super(t),this._category=n(".card__category",this.container),this._image=n(".card__image",this.container),this._description=n(".card__text",this.container),this._button=n(".card__button",this.container),this._button&&e?.onClick&&this._button.addEventListener("click",e.onClick)}set category(t){this.setText(this._category,t);for(const e in _)this._category.classList.toggle(_[e],e===t)}set image(t){this.setImage(this._image,t,this.title)}set description(t){this.setText(this._description,t)}set inBasket(t){this.setText(this._button,t?"Удалить из корзины":"Купить")}render(t){return super.render(t),t?.category&&(this.category=t.category),t?.image&&(this.image=t.image),t?.description&&(this.description=t.description),t?.inBasket&&(this.inBasket=t.inBasket),t?.price===null&&(this.setText(this._button,"Недоступно"),this.setDisable(this._button,!0)),this.container}}class M extends l{_catalog;constructor(t){super(t),this._catalog=n(".gallery",this.container)}set catalog(t){this._catalog.replaceChildren(...t)}render(t){return t?.catalog&&(this.catalog=t.catalog),this.container}}class $ extends l{constructor(t,e){super(t),this.events=e,this._content=n(".modal__content",this.container),this._closeButtons=n(".modal__close",this.container),this._closeButtons.addEventListener("click",()=>this.events.emit("modal:close")),this.container.addEventListener("click",r=>{r.target===this.container&&this.events.emit("modal:close")})}_content;_closeButtons;set content(t){this._content.replaceChildren(t)}open(){this.container.classList.add("modal_active")}close(){this.container.classList.remove("modal_active")}render(t){return t?.content&&(this.content=t.content),this.container}}class U extends l{constructor(t,e){super(t),this.events=e,this._basketButton=n(".header__basket",this.container),this._counter=n(".header__basket-counter",this.container),this._basketButton.addEventListener("click",()=>{this.events.emit("basket:open")})}_basketButton;_counter;set counter(t){this.setText(this._counter,String(t))}render(t){return t&&(this.counter=t.counter),this.container}}class D extends k{constructor(t,e){super(t),this.events=e,this._index=n(".basket__item-index",this.container),this._deleteButton=n(".basket__item-delete",this.container),this._deleteButton.addEventListener("click",()=>{this.events.emit("basket:delete",{id:this._deleteButton.dataset.id||""})})}_index;_deleteButton;set index(t){this.setText(this._index,String(t))}render(t){return super.render(t),t?.index&&(this.index=t.index+1),t?.id&&(this._deleteButton.dataset.id=t.id),this.container}}class R extends l{constructor(t,e){super(t),this.events=e,this._list=n(".basket__list",this.container),this._total=n(".basket__price",this.container),this._buyButton=n(".basket__button",this.container),this._empty=n(".basket__empty",this.container),this._buyButton.addEventListener("click",()=>{e.emit("order:open")})}_list;_total;_buyButton;_empty;set list(t){this._list.replaceChildren(...t),this.empty=t.length===0}set total(t){this.setText(this._total,`${t} синапсов`)}set empty(t){this.setDisable(this._buyButton,t),this._empty.style.display=t?"block":"none"}render(t){return t?.list&&(this.list=t.list),t&&(this.total=t.total),t?.empty&&(this.empty=t.empty),this.container}}class x extends l{_submitButton;_error;constructor(t){super(t),this._submitButton=n('.button[type="submit"]',this.container),this._error=n(".form__errors",this.container)}set valid(t){this.setDisable(this._submitButton,!t)}set error(t){this.setText(this._error,t)}render(t){return t?.valid!==void 0&&(this.valid=t.valid),t?.error!==void 0&&(this.error=t.error),this.container}}class j extends x{constructor(t,e,r){super(t),this.events=e,this._addressInput=n('input[name="address"]',this.container),this._paymentButtons=w(".button_alt",this.container),r?.onClick&&this.container.addEventListener("submit",o=>{o.preventDefault(),r.onClick()}),this._addressInput.addEventListener("input",()=>{this.events.emit("order.address:changed",{value:this._addressInput.value})}),this._paymentButtons.forEach(o=>{o.addEventListener("click",()=>{this.events.emit("order.payment:changed",{value:o.name})})})}_addressInput;_paymentButtons;set payment(t){this._paymentButtons.forEach(e=>{e.classList.toggle("button_alt-active",e.name===t)})}set address(t){this._addressInput.value=t??""}render(t){return super.render(t),t?.payment&&(this.payment=t.payment),t?.address&&(this.address=t.address),this.container}}class G extends x{constructor(t,e,r){super(t),this.events=e,this._emailInput=n('input[name="email"]',this.container),this._phoneInput=n('input[name="phone"]',this.container),r?.onClick&&this.container.addEventListener("submit",o=>{o.preventDefault(),r.onClick()}),this._emailInput.addEventListener("input",()=>{this.events.emit("order.email:changed",{value:this._emailInput.value})}),this._phoneInput.addEventListener("input",()=>{this.events.emit("order.phone:changed",{value:this._phoneInput.value})})}_emailInput;_phoneInput;set email(t){this._emailInput.value=t??""}set phone(t){this._phoneInput.value=t??""}render(t){return super.render(t),t?.email&&(this.email=t.email),t?.phone&&(this.phone=t.phone),this.container}}class H extends l{constructor(t,e){super(t),this.events=e,this._total=n(".order-success__description",this.container),this._closeButton=n(".order-success__close",this.container),this._closeButton.addEventListener("click",()=>{this.events.emit("modal:close")})}_total;_closeButton;set total(t){this.setText(this._total,`Списано ${t} синапсов`)}render(t){return t?.total&&(this.total=t.total),this.container}}const q=n("#card-catalog"),z=n("#card-preview"),J=n("#card-basket"),K=n("#basket"),N=n("#order"),Q=n("#contacts"),W=n("#success"),X=n("#modal-container"),Y=n(".header__container"),v=n(".page__wrapper"),Z=new P(A),i=new T,m=new F([],null,i),d=new I([],i),C=new L(Z,m,d),c=new E("card","","","",i),f=new $(X,i),tt=new U(Y,i),et=new M(document.body),b=new R(h(K),i),u=new j(h(N),i,{onClick:()=>i.emit("addressForm:submit")}),p=new G(h(Q),i,{onClick:()=>i.emit("contactsForm:submit")}),y=new H(h(W),i),st=()=>{i.on("modal:open",s=>{s&&(f.render({content:s}),f.open(),v.classList.add("page__wrapper_locked"))}),i.on("modal:close",()=>{f.close(),v.classList.remove("page__wrapper_locked")})},rt=()=>{i.on("catalog:changed",()=>{const s=m.getProducts().map(t=>new V(h(q),{onClick:()=>i.emit("card:selected",t)}).render(t));et.render({catalog:s})}),i.on("card:selected",s=>{m.setSelectedProduct(s);const t=d.inBasket(s.id),r=new S(h(z),{onClick:()=>{t?(i.emit("basket:delete",{id:s.id}),i.emit("modal:close")):i.emit("basket:add",s)}}).render({...s,inBasket:t});i.emit("modal:open",r)})},it=()=>{i.on("basket:changed",()=>{const s=d.getBasket().map((t,e)=>new D(h(J),i).render({...t,index:e,id:t.id}));b.render({list:s,total:d.getTotalPrise(),empty:d.getBasket().length===0}),tt.render({counter:d.getProductCounter()})}),i.on("basket:add",s=>{d.setProductItem(s),i.emit("modal:close")}),i.on("basket:delete",s=>{d.deleteProductItem(s.id)}),i.on("basket:open",()=>{i.emit("modal:open",b.render())})},nt=()=>{let s=u;i.on("order:open",()=>{const t=c.getOrder(),e=c.validateForm("addressForm");s=u,u.render({...t,valid:e.isValid,error:e.error}),i.emit("modal:open",u.render())}),i.on("addressForm:submit",()=>{const t=c.getOrder(),e=c.validateForm("contactsForm");s=p,p.render({...t,valid:e.isValid,error:e.error}),i.emit("modal:open",p.render())}),i.on("contactsForm:submit",()=>{const t=d.getTotalPrise();C.postApi(c.getOrder()),y.render({total:t}),i.emit("modal:open",y.render())}),i.on("order.address:changed",t=>{c.address=t.value}),i.on("order.payment:changed",t=>{c.payment=t.value}),i.on("order.email:changed",t=>{c.email=t.value}),i.on("order.phone:changed",t=>{c.phone=t.value}),i.on("order:changed",()=>{const t=c.getOrder();if(s===u){const e=c.validateForm("addressForm");u.render({...t,valid:e.isValid,error:e.error})}else{const e=c.validateForm("contactsForm");p.render({...t,valid:e.isValid,error:e.error})}})},ot=()=>{st(),rt(),it(),nt(),C.getApi().then(()=>{console.log("Массив товаров полученного с сервера",m.getProducts())}).catch(s=>{console.log("Ошибка получения товаров с сервера",s)})};ot();
